{
  "id": "password-reset-flow",
  "name": "Password Reset & Recovery",
  "description": "Complete password reset flow with email verification and security checks",
  "category": "auth",
  "version": "1.0.0",
  "author": "Truxe Team",
  "tags": ["password-reset", "recovery", "email-verification", "security"],
  "isPrebuilt": true,
  "createdAt": "2023-11-10T00:00:00Z",
  "updatedAt": "2023-11-10T00:00:00Z",
  "variables": [
    {
      "key": "baseUrl",
      "value": "{{baseUrl}}",
      "type": "environment",
      "scope": "workflow",
      "enabled": true,
      "description": "Base API URL",
      "createdAt": "2023-11-10T00:00:00Z",
      "updatedAt": "2023-11-10T00:00:00Z"
    },
    {
      "key": "email",
      "value": "{{$randomEmail}}",
      "type": "dynamic",
      "scope": "workflow",
      "enabled": true,
      "description": "User email address",
      "createdAt": "2023-11-10T00:00:00Z",
      "updatedAt": "2023-11-10T00:00:00Z"
    },
    {
      "key": "oldPassword",
      "value": "OldPassword123!",
      "type": "workflow",
      "scope": "workflow",
      "enabled": true,
      "description": "Current password",
      "isSecret": true,
      "createdAt": "2023-11-10T00:00:00Z",
      "updatedAt": "2023-11-10T00:00:00Z"
    },
    {
      "key": "newPassword",
      "value": "NewSecurePass456!",
      "type": "workflow",
      "scope": "workflow",
      "enabled": true,
      "description": "New password",
      "isSecret": true,
      "createdAt": "2023-11-10T00:00:00Z",
      "updatedAt": "2023-11-10T00:00:00Z"
    }
  ],
  "steps": [
    {
      "id": "check-user-exists",
      "name": "Check User Exists",
      "description": "Verify that a user with this email exists",
      "order": 1,
      "request": {
        "method": "POST",
        "url": "{{baseUrl}}/auth/check-user",
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        "body": {
          "email": "{{email}}"
        }
      },
      "expectedResponse": {
        "status": 200,
        "extractFields": ["exists", "userId"]
      },
      "extractVariables": {
        "userExists": "$.exists",
        "userId": "$.userId",
        "accountStatus": "$.status"
      },
      "onSuccess": [
        {
          "type": "log",
          "params": {
            "message": "User existence check completed"
          }
        }
      ],
      "onFailure": [
        {
          "type": "log",
          "params": {
            "message": "User existence check failed"
          }
        }
      ],
      "timeout": 5000,
      "retries": 1
    },
    {
      "id": "request-password-reset",
      "name": "Request Password Reset",
      "description": "Initiate password reset process",
      "order": 2,
      "request": {
        "method": "POST",
        "url": "{{baseUrl}}/auth/password-reset/request",
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        "body": {
          "email": "{{email}}"
        }
      },
      "expectedResponse": {
        "status": [200, 202],
        "extractFields": ["resetId", "expiresAt"]
      },
      "extractVariables": {
        "resetId": "$.resetId",
        "resetExpiresAt": "$.expiresAt",
        "emailSent": "$.emailSent"
      },
      "condition": {
        "type": "variable",
        "expression": "userExists == true",
        "description": "Only proceed if user exists"
      },
      "onSuccess": [
        {
          "type": "log",
          "params": {
            "message": "Password reset request initiated"
          }
        }
      ],
      "onFailure": [
        {
          "type": "log",
          "params": {
            "message": "Password reset request failed"
          }
        }
      ],
      "timeout": 10000,
      "retries": 1
    },
    {
      "id": "check-reset-status",
      "name": "Check Reset Status",
      "description": "Check the status of the password reset request",
      "order": 3,
      "request": {
        "method": "GET",
        "url": "{{baseUrl}}/auth/password-reset/status/{{resetId}}",
        "headers": {
          "Accept": "application/json"
        }
      },
      "expectedResponse": {
        "status": 200,
        "extractFields": ["status", "attempts"]
      },
      "extractVariables": {
        "resetStatus": "$.status",
        "attemptsMade": "$.attempts",
        "remainingAttempts": "$.remainingAttempts"
      },
      "onSuccess": [
        {
          "type": "log",
          "params": {
            "message": "Reset status retrieved"
          }
        }
      ],
      "onFailure": [
        {
          "type": "log",
          "params": {
            "message": "Failed to check reset status"
          }
        }
      ],
      "timeout": 5000,
      "retries": 1
    },
    {
      "id": "verify-reset-token",
      "name": "Verify Reset Token",
      "description": "Verify the password reset token from email",
      "order": 4,
      "request": {
        "method": "POST",
        "url": "{{baseUrl}}/auth/password-reset/verify-token",
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        "body": {
          "resetId": "{{resetId}}",
          "token": "reset-token-{{resetId}}"
        }
      },
      "expectedResponse": {
        "status": 200,
        "extractFields": ["valid", "resetToken"]
      },
      "extractVariables": {
        "tokenValid": "$.valid",
        "resetToken": "$.resetToken",
        "canProceed": "$.canReset"
      },
      "onSuccess": [
        {
          "type": "log",
          "params": {
            "message": "Reset token verified successfully"
          }
        }
      ],
      "onFailure": [
        {
          "type": "log",
          "params": {
            "message": "Reset token verification failed - you may need to use a real token from email"
          }
        }
      ],
      "timeout": 10000,
      "retries": 0
    },
    {
      "id": "validate-new-password",
      "name": "Validate New Password",
      "description": "Check if new password meets security requirements",
      "order": 5,
      "request": {
        "method": "POST",
        "url": "{{baseUrl}}/auth/password-validate",
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        "body": {
          "password": "{{newPassword}}",
          "userId": "{{userId}}"
        }
      },
      "expectedResponse": {
        "status": 200,
        "extractFields": ["valid", "strength"]
      },
      "extractVariables": {
        "passwordValid": "$.valid",
        "passwordStrength": "$.strength",
        "validationErrors": "$.errors"
      },
      "onSuccess": [
        {
          "type": "log",
          "params": {
            "message": "Password validation completed"
          }
        }
      ],
      "onFailure": [
        {
          "type": "log",
          "params": {
            "message": "Password validation failed"
          }
        }
      ],
      "timeout": 5000,
      "retries": 1
    },
    {
      "id": "reset-password",
      "name": "Reset Password",
      "description": "Complete the password reset with new password",
      "order": 6,
      "request": {
        "method": "POST",
        "url": "{{baseUrl}}/auth/password-reset/complete",
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        "body": {
          "resetToken": "{{resetToken}}",
          "newPassword": "{{newPassword}}",
          "confirmPassword": "{{newPassword}}"
        }
      },
      "expectedResponse": {
        "status": 200,
        "extractFields": ["success", "userId"]
      },
      "extractVariables": {
        "passwordReset": "$.success",
        "resetUserId": "$.userId",
        "sessionsRevoked": "$.sessionsRevoked"
      },
      "condition": {
        "type": "variable",
        "expression": "passwordValid == true && tokenValid == true",
        "description": "Only proceed if password is valid and token is verified"
      },
      "onSuccess": [
        {
          "type": "log",
          "params": {
            "message": "Password reset completed successfully"
          }
        }
      ],
      "onFailure": [
        {
          "type": "log",
          "params": {
            "message": "Password reset failed"
          }
        }
      ],
      "timeout": 10000,
      "retries": 1
    },
    {
      "id": "test-new-password-login",
      "name": "Test New Password Login",
      "description": "Verify that login works with the new password",
      "order": 7,
      "request": {
        "method": "POST",
        "url": "{{baseUrl}}/auth/login",
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        "body": {
          "email": "{{email}}",
          "password": "{{newPassword}}"
        }
      },
      "expectedResponse": {
        "status": 200,
        "extractFields": ["accessToken", "user"]
      },
      "extractVariables": {
        "newAccessToken": "$.accessToken",
        "loginSuccessful": "$.success",
        "userInfo": "$.user"
      },
      "onSuccess": [
        {
          "type": "log",
          "params": {
            "message": "Login with new password successful"
          }
        },
        {
          "type": "set-variable",
          "params": {
            "key": "Authorization",
            "value": "Bearer {{newAccessToken}}"
          }
        }
      ],
      "onFailure": [
        {
          "type": "log",
          "params": {
            "message": "Login with new password failed"
          }
        }
      ],
      "timeout": 10000,
      "retries": 1
    },
    {
      "id": "verify-old-password-invalid",
      "name": "Verify Old Password No Longer Works",
      "description": "Confirm that the old password is no longer valid",
      "order": 8,
      "request": {
        "method": "POST",
        "url": "{{baseUrl}}/auth/login",
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json"
        },
        "body": {
          "email": "{{email}}",
          "password": "{{oldPassword}}"
        }
      },
      "expectedResponse": {
        "status": 401,
        "extractFields": ["error"]
      },
      "extractVariables": {
        "oldPasswordRejected": "$.error",
        "loginFailed": "$.success"
      },
      "onSuccess": [
        {
          "type": "log",
          "params": {
            "message": "Old password correctly rejected"
          }
        }
      ],
      "onFailure": [
        {
          "type": "log",
          "params": {
            "message": "Security issue: Old password still works"
          }
        }
      ],
      "timeout": 10000,
      "retries": 0
    },
    {
      "id": "update-password-history",
      "name": "Check Password History",
      "description": "Verify password history tracking (security feature)",
      "order": 9,
      "request": {
        "method": "GET",
        "url": "{{baseUrl}}/users/{{userId}}/password-history",
        "headers": {
          "Accept": "application/json",
          "Authorization": "Bearer {{newAccessToken}}"
        }
      },
      "expectedResponse": {
        "status": 200,
        "extractFields": ["history"]
      },
      "extractVariables": {
        "passwordHistory": "$.history",
        "historyCount": "$.count",
        "lastChanged": "$.lastChanged"
      },
      "onSuccess": [
        {
          "type": "log",
          "params": {
            "message": "Password history retrieved"
          }
        }
      ],
      "onFailure": [
        {
          "type": "log",
          "params": {
            "message": "Failed to retrieve password history"
          }
        }
      ],
      "timeout": 5000,
      "retries": 1
    },
    {
      "id": "cleanup-reset-tokens",
      "name": "Cleanup Reset Tokens",
      "description": "Verify that reset tokens are properly cleaned up",
      "order": 10,
      "request": {
        "method": "DELETE",
        "url": "{{baseUrl}}/auth/password-reset/cleanup",
        "headers": {
          "Content-Type": "application/json",
          "Accept": "application/json",
          "Authorization": "Bearer {{newAccessToken}}"
        },
        "body": {
          "userId": "{{userId}}"
        }
      },
      "expectedResponse": {
        "status": [200, 204],
        "extractFields": []
      },
      "extractVariables": {
        "tokensCleanedUp": "$.cleaned",
        "cleanupCount": "$.count"
      },
      "onSuccess": [
        {
          "type": "log",
          "params": {
            "message": "Reset tokens cleaned up successfully"
          }
        }
      ],
      "onFailure": [
        {
          "type": "log",
          "params": {
            "message": "Reset token cleanup failed"
          }
        }
      ],
      "timeout": 5000,
      "retries": 1
    }
  ]
}