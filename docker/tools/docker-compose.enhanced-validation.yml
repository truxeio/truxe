# Truxe - Enhanced Docker Compose with Port Validation
# Includes comprehensive port conflict detection and resolution
# Environment: Development with validation hooks

version: '3.8'

services:
  # Port Validation Service (runs before other services)
  port-validator:
    build:
      context: .
      dockerfile: Dockerfile.port-validator
    container_name: truxe-port-validator-dev
    environment:
      NODE_ENV: development
      TRUXE_ENV: development
      TRUXE_AUTO_RESOLVE: "true"
      TRUXE_STARTUP_TIMEOUT: 30000
    volumes:
      - ./config:/app/config:ro
      - ./scripts:/app/scripts:ro
      - ./reports:/app/reports:rw
      - /var/run/docker.sock:/var/run/docker.sock:ro  # For Docker integration
    networks:
      - truxe-network
    profiles:
      - validation
    command: ["node", "/app/scripts/startup-validator.js", "--env", "development", "--auto-resolve"]

  # PostgreSQL Database
  database:
    build: 
      context: ./database
      dockerfile: Dockerfile
    container_name: truxe-db-dev
    environment:
      POSTGRES_DB: truxe.io
      POSTGRES_USER: truxe
      POSTGRES_PASSWORD: dev_password_change_me
      POSTGRES_HOST_AUTH_METHOD: md5
    ports:
      - "21432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/migrations:/docker-entrypoint-initdb.d:ro
    networks:
      - truxe-network
    restart: unless-stopped
    depends_on:
      port-validator:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U truxe -d truxe.io"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: truxe-redis-dev
    ports:
      - "21379:6379"
    volumes:
      - redis_data:/data
    networks:
      - truxe-network
    restart: unless-stopped
    depends_on:
      port-validator:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
      start_period: 10s
    command: redis-server --appendonly yes --requirepass dev_redis_password

  # Truxe API with Port Validation
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: truxe-api-dev
    environment:
      NODE_ENV: development
      PORT: 3001
      
      # Port Management Configuration
      TRUXE_ENV: development
      TRUXE_PORT_RANGE_START: 21000
      TRUXE_PORT_RANGE_END: 21999
      TRUXE_API_PORT: 21001
      TRUXE_DATABASE_PORT: 21432
      TRUXE_REDIS_PORT: 21379
      
      # Port Validation Settings
      TRUXE_PORT_VALIDATION: "true"
      TRUXE_PORT_CONFLICT_CHECK: "true"
      TRUXE_AUTO_RESOLVE_CONFLICTS: "true"
      TRUXE_STARTUP_VALIDATION_TIMEOUT: 30000
      
      # Database Configuration
      DATABASE_URL: postgresql://truxe.io_password_change_me@database:5432/truxe.io
      REDIS_URL: redis://:dev_redis_password@redis:6379
      
      # JWT Configuration
      JWT_ISSUER: truxe.io
      JWT_PRIVATE_KEY_FILE: /run/secrets/jwt_private_key
      JWT_PUBLIC_KEY_FILE: /run/secrets/jwt_public_key
      
      # Email Configuration
      EMAIL_PROVIDER: smtp
      EMAIL_FROM: noreply@truxe.local
      SMTP_HOST: mailhog
      SMTP_PORT: 1025
      SMTP_USER: ""
      SMTP_PASSWORD: ""
      SMTP_SECURE: false
      
      # CORS Configuration
      CORS_ORIGIN: http://localhost:3000,http://localhost:3002,http://localhost:21001
      LOG_LEVEL: debug
      
      # Monitoring Configuration
      ENABLE_PORT_MONITORING: "true"
      PORT_MONITORING_FREQUENCY: 10000
      PORT_MONITORING_ALERTS: "true"
      
    ports:
      - "21001:3001"
    depends_on:
      database:
        condition: service_healthy
      redis:
        condition: service_healthy
      port-validator:
        condition: service_completed_successfully
    networks:
      - truxe-network
    restart: unless-stopped
    volumes:
      - ./api/src:/app/src:ro  # Hot reload for development
      - ./config:/app/config:ro  # Port management config
      - ./reports:/app/reports:rw  # Validation reports
    secrets:
      - jwt_private_key
      - jwt_public_key
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  # MailHog for email testing
  mailhog:
    image: mailhog/mailhog:latest
    container_name: truxe-mailhog-dev
    ports:
      - "21025:1025"  # SMTP
      - "21825:8025"  # Web UI
    networks:
      - truxe-network
    restart: unless-stopped
    depends_on:
      port-validator:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8025"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s

  # Port Monitor Service (optional, for continuous monitoring)
  port-monitor:
    build:
      context: .
      dockerfile: Dockerfile.port-monitor
    container_name: truxe-port-monitor-dev
    environment:
      NODE_ENV: development
      TRUXE_ENV: development
      MONITORING_FREQUENCY: 10000
      MONITORING_DURATION: 3600000  # 1 hour
      ENABLE_ALERTS: "true"
      EXPORT_REPORTS: "true"
    volumes:
      - ./config:/app/config:ro
      - ./reports:/app/reports:rw
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - truxe-network
    profiles:
      - monitoring
    depends_on:
      - api
      - database
      - redis
    command: ["node", "-e", "
      import { portMonitor } from './config/port-monitor.js';
      import portManager from './config/ports.js';
      
      const env = process.env.TRUXE_ENV || 'development';
      const frequency = parseInt(process.env.MONITORING_FREQUENCY) || 10000;
      const duration = parseInt(process.env.MONITORING_DURATION) || 3600000;
      
      console.log('ðŸ” Starting port monitoring service...');
      
      const envConfig = portManager.getEnvironmentConfig(env);
      const ports = Object.values(envConfig.services);
      
      portMonitor.startMonitoring(ports, {
        frequency,
        environment: env,
        enableAlerts: process.env.ENABLE_ALERTS === 'true'
      });
      
      // Export reports periodically
      if (process.env.EXPORT_REPORTS === 'true') {
        setInterval(async () => {
          try {
            await portMonitor.exportMonitoringData('json', {
              includeHistory: true,
              includeStats: true,
              includePatterns: true
            });
            console.log('ðŸ“Š Monitoring report exported');
          } catch (error) {
            console.error('Failed to export monitoring report:', error.message);
          }
        }, 300000); // Every 5 minutes
      }
      
      // Stop monitoring after duration
      setTimeout(() => {
        console.log('â° Monitoring duration reached, stopping...');
        portMonitor.stopMonitoring();
        process.exit(0);
      }, duration);
      
      // Handle graceful shutdown
      process.on('SIGTERM', () => {
        console.log('ðŸ›‘ Received SIGTERM, stopping monitoring...');
        portMonitor.stopMonitoring();
        process.exit(0);
      });
    "]

  # CLI for testing and management
  cli:
    build:
      context: ./cli
      dockerfile: Dockerfile
    container_name: truxe-cli-dev
    environment:
      NODE_ENV: development
      TRUXE_API_URL: http://api:3001
      TRUXE_ENV: development
    depends_on:
      - api
    networks:
      - truxe-network
    volumes:
      - ./examples:/workspace/examples:ro
      - ./config:/workspace/config:ro
      - ./reports:/workspace/reports:rw
    profiles:
      - tools
    command: ["tail", "-f", "/dev/null"]  # Keep container running for interactive use

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

networks:
  truxe-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

secrets:
  jwt_private_key:
    file: ./secrets/jwt-private-key.pem
  jwt_public_key:
    file: ./secrets/jwt-public-key.pem

# Custom extension for port validation
x-port-validation: &port-validation
  validation_enabled: true
  auto_resolve: true
  timeout_ms: 30000
  fail_on_conflict: true
  monitoring_enabled: true
  
x-truxe-config: &truxe-config
  environment: development
  port_range:
    start: 21000
    end: 21999
  services:
    api: 21001
    database: 21432
    redis: 21379
    mailhog_smtp: 21025
    mailhog_web: 21825
  validation: *port-validation
