# Truxe - Development Environment
# Optimized for local development with hot reloading and debugging
# Port Range: 21000-21999

version: '3.8'

include:
  - docker-compose.optimized.yml

services:
  # Override API for development
  api:
    environment:
      NODE_ENV: development
      LOG_LEVEL: debug
      HOT_RELOAD: true
      DEBUG: truxe:*
      ENABLE_CORS: true
      DISABLE_RATE_LIMITING: true
    volumes:
      - ./api/src:/app/src:rw
      - ./api/logs:/app/logs:rw
    ports:
      - "${TRUXE_API_PORT:-21001}:21001"
      - "${TRUXE_API_DEBUG_PORT:-21901}:9229"  # Node.js debug port
    command: npm run dev:debug

  # Override Database for development
  database:
    environment:
      POSTGRES_DB: truxe.io
      POSTGRES_LOG_STATEMENT: all
      POSTGRES_LOG_MIN_DURATION_STATEMENT: 0
    ports:
      - "${TRUXE_DB_PORT:-21432}:5432"

  # Override Redis for development
  redis:
    ports:
      - "${TRUXE_REDIS_PORT:-21379}:6379"
    command: |
      redis-server --appendonly yes --appendfsync everysec --save 60 1000

  # Override Traefik for development
  traefik:
    ports:
      - "${TRUXE_TRAEFIK_HTTP_PORT:-21080}:80"
      - "${TRUXE_TRAEFIK_DASHBOARD_PORT:-21081}:8080"
    command:
      - --api.dashboard=true
      - --api.insecure=true
      - --log.level=DEBUG
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80

  # Development-specific services
  mailhog:
    ports:
      - "${TRUXE_MAILHOG_SMTP_PORT:-21025}:1025"
      - "${TRUXE_MAILHOG_WEB_PORT:-21825}:8025"
    profiles: []  # Always start in development

  prometheus:
    ports:
      - "${TRUXE_PROMETHEUS_PORT:-21005}:9090"
    profiles: []  # Always start in development

  grafana:
    ports:
      - "${TRUXE_GRAFANA_PORT:-21004}:3000"
    profiles: []  # Always start in development

  consul:
    ports:
      - "${TRUXE_CONSUL_PORT:-21500}:8500"
      - "${TRUXE_CONSUL_DNS_PORT:-21600}:8600/udp"

  # Hot reload file watcher
  file-watcher:
    image: node:18-alpine
    container_name: truxe-watcher-dev
    working_dir: /app
    volumes:
      - ./api:/app:ro
      - /app/node_modules
    networks:
      - truxe-backend
    command: |
      sh -c '
        npm install -g nodemon chokidar-cli &&
        chokidar "**/*.js" "**/*.json" -c "echo File changed: {path} && curl -X POST http://api:21001/dev/reload"
      '
    profiles:
      - development
    restart: unless-stopped

  # Development database seeder
  db-seeder:
    build:
      context: ./database
      dockerfile: Dockerfile.seeder
    container_name: truxe-seeder-dev
    environment:
      DATABASE_URL: postgresql://truxe:$$(cat /run/secrets/db_password)@database:5432/truxe.io
      SEED_DATA: development
    depends_on:
      database:
        condition: service_healthy
    networks:
      - truxe-backend
    volumes:
      - ./database/seeds:/app/seeds:ro
    secrets:
      - db_password
    profiles:
      - seeding
    restart: "no"

networks:
  truxe-frontend:
    ipam:
      config:
        - subnet: 172.20.0.0/16
  truxe-backend:
    ipam:
      config:
        - subnet: 172.21.0.0/16
