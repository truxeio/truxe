version: '3.8'

services:
  # PostgreSQL Database
  database:
    build:
      context: ./database
      dockerfile: Dockerfile
    container_name: truxe-db
    environment:
      POSTGRES_DB: truxe_prod
      POSTGRES_USER: truxe
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_HOST_AUTH_METHOD: md5
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/migrations:/docker-entrypoint-initdb.d:ro
    networks:
      - truxe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U truxe -d truxe_prod"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: truxe-redis
    volumes:
      - redis_data:/data
    networks:
      - truxe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    command: redis-server --appendonly yes --requirepass ${REDIS_PASSWORD}

  # Truxe API
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: truxe-api
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3001
      # Database (container-to-container)
      DATABASE_URL: postgresql://truxe:em1sJ185vbYnWaNyIvTJ5%2FQwLSU0myUy@database:5432/truxe_prod?sslmode=disable
      REDIS_URL: redis://:1dHT%2FfHmYZbwUEm0u%2FFM2jRNTBQ09EUo@redis:6379
      # JWT Configuration
      JWT_PRIVATE_KEY_BASE64: ${JWT_PRIVATE_KEY_BASE64}
      JWT_PUBLIC_KEY_BASE64: ${JWT_PUBLIC_KEY_BASE64}
      JWT_ISSUER: https://auth.truxe.io
      JWT_ALGORITHM: RS256
      # Email
      EMAIL_PROVIDER: brevo
      BREVO_API_KEY: ${BREVO_API_KEY}
      EMAIL_FROM: noreply@truxe.io
      EMAIL_FROM_NAME: Truxe
      # OAuth
      GITHUB_OAUTH_CLIENT_ID: ${GITHUB_CLIENT_ID}
      GITHUB_OAUTH_CLIENT_SECRET: ${GITHUB_CLIENT_SECRET}
      GITHUB_OAUTH_REDIRECT_URI: https://api.truxe.io/auth/oauth/callback/github
      # URLs
      FRONTEND_URL: https://truxe.io
      API_URL: https://api.truxe.io
      OAUTH_CALLBACK_BASE_URL: https://api.truxe.io
      # Security
      COOKIE_SECRET: ${COOKIE_SECRET}
      SESSION_SECRET: ${SESSION_SECRET}
      OAUTH_STATE_SECRET: ${OAUTH_STATE_SECRET}
      OAUTH_TOKEN_ENCRYPTION_KEY: ${OAUTH_TOKEN_ENCRYPTION_KEY}
      # CORS
      CORS_ORIGIN: https://truxe.io,https://www.truxe.io
    depends_on:
      database:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - truxe-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Truxe Website
  website:
    build:
      context: ../
      dockerfile: packages/website/Dockerfile
    container_name: truxe-website
    restart: unless-stopped
    environment:
      NODE_ENV: production
      PORT: 3000
      # Site Configuration
      NEXT_PUBLIC_SITE_URL: https://truxe.io
      NEXT_PUBLIC_API_URL: https://api.truxe.io
      # Brevo Waitlist
      BREVO_API_KEY: ${BREVO_API_KEY}
      BREVO_LIST_ID: ${BREVO_LIST_ID}
      # Analytics (optional)
      NEXT_PUBLIC_PLAUSIBLE_DOMAIN: truxe.io
    networks:
      - truxe-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    container_name: truxe-nginx
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./deployment/nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./deployment/nginx/conf.d:/etc/nginx/conf.d:ro
      - ./deployment/ssl:/etc/nginx/ssl:ro
      - ./deployment/nginx/logs:/var/log/nginx
    depends_on:
      - api
      - website
    networks:
      - truxe-network

volumes:
  postgres_data:
    name: truxe_postgres_data
  redis_data:
    name: truxe_redis_data

networks:
  truxe-network:
    driver: bridge
    name: truxe-network