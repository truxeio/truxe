# Truxe - Enhanced Docker Compose with Centralized Port Management
# Automatically configured using the centralized port management system
# Environment: Development (87000-87099 port range)
#
# Port Mapping Strategy:
#   External (Host): 87XXX range for conflict avoidance
#   Internal (Container): Industry standard defaults
#   Pattern: ${TRUXE_SERVICE_PORT:-87XXX}:STANDARD_PORT
#
# Reference: docs/deployment/PORT_MAPPING_STRATEGY.md

services:
  # PostgreSQL Database
  database:
    build:
      context: ./database
      dockerfile: Dockerfile
    container_name: truxe-db-dev
    environment:
      POSTGRES_DB: truxe.io
      POSTGRES_USER: truxe
      POSTGRES_PASSWORD: dev_password_change_me
      POSTGRES_HOST_AUTH_METHOD: md5
    ports:
      - "${TRUXE_DB_PORT:-87032}:5432"  # External custom → Internal default
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/migrations:/docker-entrypoint-initdb.d:ro
    networks:
      - truxe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U truxe -d truxe.io"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Redis Cache
  redis:
    image: redis:7-alpine
    container_name: truxe-redis-dev
    ports:
      - "${TRUXE_REDIS_PORT:-87079}:6379"  # External custom → Internal default
    volumes:
      - redis_data:/data
    networks:
      - truxe-network
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    command: redis-server --appendonly yes --requirepass dev_redis_password

  # Truxe API
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
    container_name: truxe-api-dev
    environment:
      NODE_ENV: development
      PORT: 3001  # Internal container port (standard Node.js)
      # Port Management Configuration
      TRUXE_ENV: development
      TRUXE_PORT_RANGE_START: 87000
      TRUXE_PORT_RANGE_END: 87099
      TRUXE_API_PORT: 87001
      TRUXE_DB_PORT: 87032
      TRUXE_REDIS_PORT: 87079
      # Database Configuration (container-to-container uses service names + defaults)
      DATABASE_URL: postgresql://truxe.io_password_change_me@database:5432/truxe.io
      REDIS_URL: redis://:dev_redis_password@redis:6379
      # JWT Configuration
      JWT_ISSUER: truxe.io
      JWT_ALGORITHM: RS256
      JWT_PRIVATE_KEY: "-----BEGIN PRIVATE KEY-----\nMIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQCl10mFXeNRtCPC\nUlWxQAPVZM8gwedHF+9lK/5w8wWIRltZc6rWELcgtYdgf6hNiG/eCOVX3g+NdxdR\nstTHJbqPkGxWfrR+RvH09JZYvuefccC9y4pIRDjEA9b6ZQ9XzmsDVKZfar9OsZZv\nIi9AwZMPrKnrynS6ni3vOKM8fkmx1zd2dDQBAP3BaPW9fW9Z6TfRSAZTPit9AXAR\nOVVFeXHTJkVwIfBMGP5yYbUXVthI3vO/ouWZ1spXtonR258RUGhctz1Cl1bbI/NM\nNdpXURdnhrLUNQxChga3y3cpdZpdRkw2cTnO1nI/tMMN2zWx8mjBGIC2YXEJlGPp\nfFh/V4orAgMBAAECggEACKUfX69ploHAd3Ruo83Feria6jHmyi2fkh49UPVU2CoV\navqnm38a52lEbwMDP/9ubXGjRaBSyToTDMmODqTog8FbPxWzIlNfxjgrJOHWwINf\n28T3fBWVAUrTSGbqP4Ey0jqgbaA/7Bc/001B5KtH7Ozq8rAGw7pT2gDm1Cl1KABi\n7UxbFBH9a3zrRX66g5bczuUREMdTRX4LQ1LGzSQZCMx5SH3XKyo+wfSovFwUQo5z\nz0D/z2litHWP+LYiDg5LyRbnKscNtqolUTxaAKbL5Bo6GnenQSxui4CZAZgGZG8C\n+2EP5/7gXxqqZ40/SINmSOS3v0Q5lmD9/F+EQSfLQQKBgQDO/UyfwyY52lOr3sdU\ndOFIDu0Zz4ieKVLx2q9JEGq7hGIS7WqoydshrYEFOrQYsZWL1judMR4qEUAWcBwI\nalhMRtxXeAQ64ckszyZaTViZNpjt3xe0W9OOP2MfgGcj49DIATAXp+wYKawTq8xf\nPNMeJ9U22qTxPIJFNfkF92lGCwKBgQDNG8P2n4nf5Gj7qFvvAmbl9gTnB+nm/JwH\nELHNqxx8pCDVsd1/CNeiDjthYSIXCptho6dyV2WQub3H3K64iIUF03Y3hLgwmh+0\nIERV+cZlcgmniAD20xAcAa0ea9uiLTiDjeXxMNKx9dWd6DdW6Z5erx5SrUEX+Na+\nqIKNDdwAYQKBgDy/dleFDJj6DIhqj5Gn494kE0357JyOgDte9Qa6fLif97CaYS08\nYMWXiEAipGyC4eLycviFS9cIzQhIytFldJieS1iYbpVhYot2GEl0XcZJkcRuLyTN\ntl8PF2ZNZvfPipzITHcE33OP92Kmjwp8bXFyO08oCDSMj6cEWht4KztVAoGAfAmr\ng6zNg3GtL2uMVUk9kxopstGtWTww23D0Je2x54qWNMVArv9Y8C7tKCHGrOqENxLy\nQ4qo6FH7fC9wFjaxQ2mzVzXS8clzHMpaqSfJHDZPslnkQ2A2oMk+uWP+yd/RCnW4\nthiRgn+ptLnnJY9Yb+g1TUhrUiTxMRHVCZp1DmECgYEAqHqVaT0fki0CmWM7vCkz\nqtm+DkRh/4A47xI7315H2PJLLTq37J0PNYscAby3scEUpOvG4PdO6kPV0X/H8R4h\nVex7KMwgTC6sSEZ/VjjUFTvt3LddPleX15Ext6VznSU454+xLhiMh1SGRQlWJfUy\nhqKBP6Y3wqYSUcAsh4ZeDhc=\n-----END PRIVATE KEY-----\n"
      JWT_PUBLIC_KEY: "-----BEGIN PUBLIC KEY-----\nMIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEApddJhV3jUbQjwlJVsUAD\n1WTPIMHnRxfvZSv+cPMFiEZbWXOq1hC3ILWHYH+oTYhv3gjlV94PjXcXUbLUxyW6\nj5BsVn60fkbx9PSWWL7nn3HAvcuKSEQ4xAPW+mUPV85rA1SmX2q/TrGWbyIvQMGT\nD6yp68p0up4t7zijPH5Jsdc3dnQ0AQD9wWj1vX1vWek30UgGUz4rfQFwETlVRXlx\n0yZFcCHwTBj+cmG1F1bYSN7zv6LlmdbKV7aJ0dufEVBoXLc9QpdW2yPzTDXaV1EX\nZ4ay1DUMQoYGt8t3KXWaXUZMNnE5ztZyP7TDDds1sfJowRiAtmFxCZRj6XxYf1eK\nKwIDAQAB\n-----END PUBLIC KEY-----\n"
      # Email Configuration
      EMAIL_PROVIDER: brevo
      EMAIL_FROM: noreply@truxe.local
      EMAIL_FROM_NAME: Truxe Auth
      BREVO_API_KEY: test-key
      # SMTP Configuration (fallback)
      SMTP_HOST: mailhog
      SMTP_PORT: 1025
      SMTP_USER: ""
      SMTP_PASS: ""
      SMTP_SECURE: false
      # CORS Configuration
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3000,http://localhost:3002,http://localhost:87001}
      LOG_LEVEL: debug
      # Port Validation
      TRUXE_PORT_VALIDATION: true
      TRUXE_PORT_CONFLICT_CHECK: true
    ports:
      - "${TRUXE_API_PORT:-87001}:3001"  # External custom → Internal conventional
    depends_on:
      database:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - truxe-network
    restart: unless-stopped
    volumes:
      - ./api/src:/app/src:ro  # Hot reload for development
      - ./config:/config:ro  # Port management configuration
    secrets:
      - jwt_private_key
      - jwt_public_key
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]  # Check internal port
      interval: 30s
      timeout: 10s
      retries: 3

  # MailHog for email testing
  mailhog:
    image: mailhog/mailhog:latest
    container_name: truxe-mailhog-dev
    ports:
      - "${TRUXE_MAILHOG_SMTP_PORT:-87025}:1025"  # SMTP: External custom → Internal default
      - "${TRUXE_MAILHOG_WEB_PORT:-87825}:8025"   # Web UI: External custom → Internal default
    networks:
      - truxe-network
    restart: unless-stopped

  # Port Monitor Service (disabled - not needed for basic development)
  # port-monitor:
  #   build:
  #     context: .
  #     dockerfile: Dockerfile.port-monitor
  #   container_name: truxe-port-monitor-dev
  #   environment:
  #     NODE_ENV: development
  #     TRUXE_ENV: development
  #     MONITORING_PORT: 8080  # Internal container port
  #     TRUXE_PORT_RANGE_START: 87000
  #     TRUXE_PORT_RANGE_END: 87099
  #   ports:
  #     - "${TRUXE_MONITORING_PORT:-87090}:8080"  # External custom → Internal default
  #   depends_on:
  #     - api
  #     - database
  #     - redis
  #   networks:
  #     - truxe-network
  #   volumes:
  #     - ./config:/app/config:ro
  #     - ./reports:/app/reports:rw
  #   restart: unless-stopped
  #   healthcheck:
  #     test: ["CMD", "curl", "-f", "http://localhost:8080/health"]  # Check internal port
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3

  # CLI for testing
  cli:
    build:
      context: ./cli
      dockerfile: Dockerfile
    container_name: truxe-cli-dev
    environment:
      NODE_ENV: development
      # Container-to-container communication uses service name + internal port
      TRUXE_API_URL: http://api:3001
    depends_on:
      - api
    networks:
      - truxe-network
    volumes:
      - ./examples:/workspace/examples:ro
    profiles:
      - tools  # Only start when explicitly requested

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local

networks:
  truxe-network:
    driver: bridge

secrets:
  jwt_private_key:
    file: ./secrets/jwt-private-key.pem
  jwt_public_key:
    file: ./secrets/jwt-public-key.pem
