# Truxe - Optimized Docker Compose Configuration
# Enhanced with advanced port management, service discovery, and monitoring
# Version: 2.0.0 - DevOps Optimized

version: '3.8'

x-common-variables: &common-variables
  TRUXE_ENV: ${TRUXE_ENV:-development}
  TRUXE_PORT_VALIDATION: ${TRUXE_PORT_VALIDATION:-true}
  TRUXE_PORT_CONFLICT_CHECK: ${TRUXE_PORT_CONFLICT_CHECK:-true}
  TRUXE_SERVICE_DISCOVERY: ${TRUXE_SERVICE_DISCOVERY:-true}
  LOG_LEVEL: ${LOG_LEVEL:-info}
  METRICS_ENABLED: ${METRICS_ENABLED:-true}

x-common-healthcheck: &common-healthcheck
  interval: 15s
  timeout: 10s
  retries: 3
  start_period: 30s

x-common-logging: &common-logging
  driver: "json-file"
  options:
    max-size: "10m"
    max-file: "3"
    labels: "service,environment,version"

x-resource-limits: &resource-limits
  deploy:
    resources:
      limits:
        memory: 512M
        cpus: '0.5'
      reservations:
        memory: 256M
        cpus: '0.25'

services:
  # Service Discovery and Load Balancer
  traefik:
    image: traefik:v3.0
    container_name: truxe-traefik-${TRUXE_ENV:-dev}
    command:
      - --api.dashboard=true
      - --api.insecure=true
      - --providers.docker=true
      - --providers.docker.exposedbydefault=false
      - --entrypoints.web.address=:80
      - --entrypoints.websecure.address=:443
      - --certificatesresolvers.letsencrypt.acme.email=${ACME_EMAIL:-admin@truxe.local}
      - --certificatesresolvers.letsencrypt.acme.storage=/acme.json
      - --certificatesresolvers.letsencrypt.acme.httpchallenge.entrypoint=web
      - --metrics.prometheus=true
      - --metrics.prometheus.addEntryPointsLabels=true
      - --metrics.prometheus.addServicesLabels=true
      - --log.level=${TRAEFIK_LOG_LEVEL:-INFO}
      - --accesslog=true
    ports:
      - "${TRUXE_TRAEFIK_HTTP_PORT:-${TRUXE_API_PORT:-21001}}:80"
      - "${TRUXE_TRAEFIK_HTTPS_PORT:-21443}:443"
      - "${TRUXE_TRAEFIK_DASHBOARD_PORT:-21080}:8080"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - traefik_data:/data
      - ./config/traefik:/etc/traefik/dynamic:ro
    networks:
      - truxe-frontend
      - truxe-backend
    restart: unless-stopped
    healthcheck:
      <<: *common-healthcheck
      test: ["CMD", "traefik", "healthcheck", "--ping"]
    logging: *common-logging
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.traefik.rule=Host(`traefik.${DOMAIN:-localhost}`)"
      - "traefik.http.routers.traefik.service=api@internal"
      - "truxe.service=traefik"
      - "truxe.environment=${TRUXE_ENV:-development}"

  # PostgreSQL Database with Enhanced Health Checks
  database:
    build: 
      context: ./database
      dockerfile: Dockerfile
    container_name: truxe-db-${TRUXE_ENV:-dev}
    environment:
      <<: *common-variables
      POSTGRES_DB: truxe_${TRUXE_ENV:-dev}
      POSTGRES_USER: ${POSTGRES_USER:-truxe}
      POSTGRES_PASSWORD_FILE: /run/secrets/db_password
      POSTGRES_INITDB_ARGS: "--auth-host=md5"
      # Performance Tuning
      POSTGRES_SHARED_BUFFERS: ${DB_SHARED_BUFFERS:-256MB}
      POSTGRES_EFFECTIVE_CACHE_SIZE: ${DB_EFFECTIVE_CACHE_SIZE:-1GB}
      POSTGRES_MAINTENANCE_WORK_MEM: ${DB_MAINTENANCE_WORK_MEM:-64MB}
      POSTGRES_CHECKPOINT_COMPLETION_TARGET: ${DB_CHECKPOINT_COMPLETION_TARGET:-0.9}
      POSTGRES_WAL_BUFFERS: ${DB_WAL_BUFFERS:-16MB}
      POSTGRES_DEFAULT_STATISTICS_TARGET: ${DB_DEFAULT_STATISTICS_TARGET:-100}
    expose:
      - "5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./database/migrations:/docker-entrypoint-initdb.d:ro
      - ./database/config/postgresql.conf:/etc/postgresql/postgresql.conf:ro
      - ./database/scripts:/docker-entrypoint-initdb.d/scripts:ro
    networks:
      - truxe-backend
    restart: unless-stopped
    secrets:
      - db_password
    healthcheck:
      <<: *common-healthcheck
      test: |
        pg_isready -U ${POSTGRES_USER:-truxe} -d truxe_${TRUXE_ENV:-dev} &&
        psql -U ${POSTGRES_USER:-truxe} -d truxe_${TRUXE_ENV:-dev} -c "SELECT 1" > /dev/null 2>&1
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 60s
    logging: *common-logging
    <<: *resource-limits
    labels:
      - "truxe.service=database"
      - "truxe.environment=${TRUXE_ENV:-development}"
      - "truxe.port.internal=5432"

  # Redis Cache with Clustering Support
  redis:
    image: redis:7-alpine
    container_name: truxe-redis-${TRUXE_ENV:-dev}
    environment:
      <<: *common-variables
    expose:
      - "6379"
    volumes:
      - redis_data:/data
      - ./config/redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - truxe-backend
    restart: unless-stopped
    secrets:
      - redis_password
    command: |
      sh -c '
        redis-server /usr/local/etc/redis/redis.conf \
        --requirepass "$$(cat /run/secrets/redis_password)" \
        --appendonly yes \
        --appendfsync everysec \
        --auto-aof-rewrite-percentage 100 \
        --auto-aof-rewrite-min-size 64mb
      '
    healthcheck:
      <<: *common-healthcheck
      test: |
        redis-cli --no-auth-warning -a "$$(cat /run/secrets/redis_password)" ping &&
        redis-cli --no-auth-warning -a "$$(cat /run/secrets/redis_password)" info replication
      interval: 10s
      timeout: 3s
      retries: 3
    logging: *common-logging
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.25'
        reservations:
          memory: 128M
          cpus: '0.1'
    labels:
      - "truxe.service=redis"
      - "truxe.environment=${TRUXE_ENV:-development}"
      - "truxe.port.internal=6379"

  # Truxe API with Enhanced Monitoring
  api:
    build:
      context: ./api
      dockerfile: Dockerfile
      args:
        NODE_ENV: ${NODE_ENV:-development}
        BUILD_VERSION: ${BUILD_VERSION:-latest}
    container_name: truxe-api-${TRUXE_ENV:-dev}
    environment:
      <<: *common-variables
      NODE_ENV: ${NODE_ENV:-development}
      PORT: 21001
      # Database Configuration
      DATABASE_URL: postgresql://${POSTGRES_USER:-truxe}:$$(cat /run/secrets/db_password)@database:5432/truxe_${TRUXE_ENV:-dev}?sslmode=prefer
      REDIS_URL: redis://:$$(cat /run/secrets/redis_password)@redis:6379
      # JWT Configuration
      JWT_ISSUER: truxe-${TRUXE_ENV:-dev}
      JWT_PRIVATE_KEY_FILE: /run/secrets/jwt_private_key
      JWT_PUBLIC_KEY_FILE: /run/secrets/jwt_public_key
      JWT_ACCESS_TOKEN_EXPIRY: ${JWT_ACCESS_TOKEN_EXPIRY:-15m}
      JWT_REFRESH_TOKEN_EXPIRY: ${JWT_REFRESH_TOKEN_EXPIRY:-7d}
      # Email Configuration
      EMAIL_PROVIDER: ${EMAIL_PROVIDER:-smtp}
      EMAIL_FROM: ${EMAIL_FROM:-noreply@truxe.local}
      EMAIL_API_KEY_FILE: /run/secrets/email_api_key
      SMTP_HOST: ${SMTP_HOST:-mailhog}
      SMTP_PORT: ${SMTP_PORT:-1025}
      SMTP_SECURE: ${SMTP_SECURE:-false}
      # CORS Configuration
      CORS_ORIGIN: ${CORS_ORIGIN:-http://localhost:3000,http://localhost:3002}
      # Security Configuration
      RATE_LIMIT_WINDOW_MS: ${RATE_LIMIT_WINDOW_MS:-900000}
      RATE_LIMIT_MAX_REQUESTS: ${RATE_LIMIT_MAX_REQUESTS:-100}
      BCRYPT_ROUNDS: ${BCRYPT_ROUNDS:-12}
      # Monitoring Configuration
      METRICS_PORT: 9090
      HEALTH_CHECK_TIMEOUT: ${HEALTH_CHECK_TIMEOUT:-5000}
      # Service Discovery
      SERVICE_NAME: truxe-api
      SERVICE_VERSION: ${BUILD_VERSION:-latest}
      SERVICE_TAGS: api,backend,core
    expose:
      - "21001"
      - "9090"
    depends_on:
      database:
        condition: service_healthy
      redis:
        condition: service_healthy
    networks:
      - truxe-frontend
      - truxe-backend
    restart: unless-stopped
    volumes:
      - ./api/src:/app/src:ro
      - ./api/logs:/app/logs
      - api_uploads:/app/uploads
    secrets:
      - db_password
      - redis_password
      - jwt_private_key
      - jwt_public_key
      - email_api_key
    healthcheck:
      <<: *common-healthcheck
      test: |
        curl -f http://localhost:21001/health/ready &&
        curl -f http://localhost:21001/health/live &&
        curl -f http://localhost:9090/metrics
      interval: 15s
      timeout: 10s
      retries: 3
      start_period: 45s
    logging: *common-logging
    <<: *resource-limits
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.api.rule=Host(`api.${DOMAIN:-localhost}`) || PathPrefix(`/api`)"
      - "traefik.http.routers.api.service=api"
      - "traefik.http.services.api.loadbalancer.server.port=21001"
      - "traefik.http.services.api.loadbalancer.healthcheck.path=/health/ready"
      - "traefik.http.services.api.loadbalancer.healthcheck.interval=30s"
      - "truxe.service=api"
      - "truxe.environment=${TRUXE_ENV:-development}"
      - "truxe.port.internal=21001"
      - "truxe.port.metrics=9090"

  # Service Discovery Agent
  consul:
    image: consul:1.16
    container_name: truxe-consul-${TRUXE_ENV:-dev}
    environment:
      <<: *common-variables
      CONSUL_BIND_INTERFACE: eth0
      CONSUL_CLIENT_INTERFACE: eth0
    command: |
      consul agent -dev 
      -client=0.0.0.0 
      -ui 
      -log-level=${CONSUL_LOG_LEVEL:-INFO}
      -enable-script-checks=true
      -config-dir=/consul/config
    expose:
      - "8500"
      - "8600"
    volumes:
      - consul_data:/consul/data
      - ./config/consul:/consul/config:ro
    networks:
      - truxe-backend
      - truxe-frontend
    restart: unless-stopped
    healthcheck:
      <<: *common-healthcheck
      test: ["CMD", "consul", "members"]
      interval: 10s
      timeout: 3s
      retries: 3
    logging: *common-logging
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.consul.rule=Host(`consul.${DOMAIN:-localhost}`)"
      - "traefik.http.services.consul.loadbalancer.server.port=8500"
      - "truxe.service=consul"
      - "truxe.environment=${TRUXE_ENV:-development}"

  # Enhanced Monitoring Stack
  prometheus:
    image: prom/prometheus:latest
    container_name: truxe-prometheus-${TRUXE_ENV:-dev}
    environment:
      <<: *common-variables
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.console.libraries=/etc/prometheus/console_libraries'
      - '--web.console.templates=/etc/prometheus/consoles'
      - '--storage.tsdb.retention.time=30d'
      - '--web.enable-lifecycle'
      - '--web.enable-admin-api'
      - '--storage.tsdb.wal-compression'
    expose:
      - "9090"
    volumes:
      - ./deploy/monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - ./deploy/monitoring/rules:/etc/prometheus/rules:ro
      - prometheus_data:/prometheus
    networks:
      - truxe-backend
      - truxe-frontend
    restart: unless-stopped
    depends_on:
      - api
      - consul
    healthcheck:
      <<: *common-healthcheck
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/-/healthy"]
      interval: 30s
      timeout: 10s
      retries: 3
    logging: *common-logging
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.prometheus.rule=Host(`prometheus.${DOMAIN:-localhost}`)"
      - "traefik.http.services.prometheus.loadbalancer.server.port=9090"
      - "truxe.service=prometheus"
      - "truxe.environment=${TRUXE_ENV:-development}"

  # Grafana with Enhanced Dashboards
  grafana:
    image: grafana/grafana:latest
    container_name: truxe-grafana-${TRUXE_ENV:-dev}
    environment:
      <<: *common-variables
      GF_SECURITY_ADMIN_PASSWORD_FILE: /run/secrets/grafana_admin_password
      GF_USERS_ALLOW_SIGN_UP: false
      GF_INSTALL_PLUGINS: grafana-piechart-panel,grafana-worldmap-panel,grafana-clock-panel
      GF_FEATURE_TOGGLES_ENABLE: publicDashboards
      GF_ANALYTICS_REPORTING_ENABLED: false
      GF_ANALYTICS_CHECK_FOR_UPDATES: false
      GF_SECURITY_ANGULAR_SUPPORT_ENABLED: true
    expose:
      - "3000"
    volumes:
      - grafana_data:/var/lib/grafana
      - ./deploy/monitoring/grafana/dashboards:/etc/grafana/provisioning/dashboards:ro
      - ./deploy/monitoring/grafana/datasources:/etc/grafana/provisioning/datasources:ro
      - ./deploy/monitoring/grafana/plugins:/var/lib/grafana/plugins:ro
    networks:
      - truxe-backend
      - truxe-frontend
    restart: unless-stopped
    depends_on:
      - prometheus
    secrets:
      - grafana_admin_password
    healthcheck:
      <<: *common-healthcheck
      test: ["CMD-SHELL", "curl -f http://localhost:3000/api/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging: *common-logging
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.grafana.rule=Host(`grafana.${DOMAIN:-localhost}`)"
      - "traefik.http.services.grafana.loadbalancer.server.port=3000"
      - "truxe.service=grafana"
      - "truxe.environment=${TRUXE_ENV:-development}"

  # MailHog for Development Email Testing
  mailhog:
    image: mailhog/mailhog:latest
    container_name: truxe-mailhog-${TRUXE_ENV:-dev}
    environment:
      <<: *common-variables
      MH_STORAGE: maildir
      MH_MAILDIR_PATH: /maildir
    expose:
      - "1025"
      - "8025"
    volumes:
      - mailhog_data:/maildir
    networks:
      - truxe-backend
      - truxe-frontend
    restart: unless-stopped
    healthcheck:
      <<: *common-healthcheck
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8025"]
      interval: 30s
      timeout: 5s
      retries: 3
    logging: *common-logging
    profiles:
      - development
      - testing
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.mailhog.rule=Host(`mail.${DOMAIN:-localhost}`)"
      - "traefik.http.services.mailhog.loadbalancer.server.port=8025"
      - "truxe.service=mailhog"
      - "truxe.environment=${TRUXE_ENV:-development}"

  # Port Monitor Service
  port-monitor:
    build:
      context: .
      dockerfile: Dockerfile.port-monitor
    container_name: truxe-port-monitor-${TRUXE_ENV:-dev}
    environment:
      <<: *common-variables
      MONITOR_INTERVAL: ${PORT_MONITOR_INTERVAL:-30}
      ALERT_THRESHOLD: ${PORT_ALERT_THRESHOLD:-80}
      PROMETHEUS_GATEWAY: http://prometheus:9090
    volumes:
      - ./config:/app/config:ro
      - ./scripts:/app/scripts:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - port_monitor_data:/app/data
    networks:
      - truxe-backend
    restart: unless-stopped
    depends_on:
      - prometheus
      - consul
    healthcheck:
      <<: *common-healthcheck
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    logging: *common-logging
    labels:
      - "truxe.service=port-monitor"
      - "truxe.environment=${TRUXE_ENV:-development}"

  # CLI Tools Container
  cli:
    build:
      context: ./cli
      dockerfile: Dockerfile
    container_name: truxe-cli-${TRUXE_ENV:-dev}
    environment:
      <<: *common-variables
      NODE_ENV: ${NODE_ENV:-development}
      TRUXE_API_URL: http://api:21001
      CONSUL_HTTP_ADDR: consul:8500
    depends_on:
      api:
        condition: service_healthy
      consul:
        condition: service_healthy
    networks:
      - truxe-backend
    volumes:
      - ./examples:/workspace/examples:ro
      - cli_data:/workspace/data
    profiles:
      - tools
    logging: *common-logging
    labels:
      - "truxe.service=cli"
      - "truxe.environment=${TRUXE_ENV:-development}"

volumes:
  postgres_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/postgres
  redis_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/redis
  prometheus_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/prometheus
  grafana_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/grafana
  consul_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/consul
  traefik_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ${DATA_PATH:-./data}/traefik
  mailhog_data:
    driver: local
  api_uploads:
    driver: local
  port_monitor_data:
    driver: local
  cli_data:
    driver: local

networks:
  truxe-frontend:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
    labels:
      - "truxe.network=frontend"
      - "truxe.environment=${TRUXE_ENV:-development}"
  truxe-backend:
    driver: bridge
    internal: true
    ipam:
      config:
        - subnet: 172.21.0.0/16
    labels:
      - "truxe.network=backend"
      - "truxe.environment=${TRUXE_ENV:-development}"

secrets:
  db_password:
    file: ./secrets/db_password.txt
  redis_password:
    file: ./secrets/redis_password.txt
  jwt_private_key:
    file: ./secrets/jwt-private-key.pem
  jwt_public_key:
    file: ./secrets/jwt-public-key.pem
  email_api_key:
    file: ./secrets/email_api_key.txt
  grafana_admin_password:
    file: ./secrets/grafana_admin_password.txt
